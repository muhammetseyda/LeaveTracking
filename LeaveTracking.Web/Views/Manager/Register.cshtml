@using LeaveTracking.Application.DTOs.UserDTOs
@model UserDto
@{
    ViewBag.Title = "Kullanıcı Yönetimi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-md-12">
        <h2>Kullanıcı Yönetimi</h2>
        <p class="text-muted">Yeni kullanıcı ekleyin ve mevcut kullanıcıları yönetin</p>
        <hr />
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-user-plus me-2"></i>
                    Yeni Kullanıcı Ekle
                </h5>
            </div>
            <div class="card-body">
                @if (ViewBag.Error != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        @ViewBag.Error
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }

                @if (ViewBag.Success != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        @ViewBag.Success
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }

                <form asp-action="Register" asp-controller="Manager" method="post" onsubmit="handleSubmit(this)">
                    @Html.AntiForgeryToken()

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="FirstName" class="form-label">Ad</label>
                                <input asp-for="FirstName" class="form-control" placeholder="Adını girin" />
                                <span asp-validation-for="FirstName" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="LastName" class="form-label">Soyad</label>
                                <input asp-for="LastName" class="form-control" placeholder="Soyadını girin" />
                                <span asp-validation-for="LastName" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Email" class="form-label">Email Adresi</label>
                                <input asp-for="Email" type="email" class="form-control" placeholder="ornek@email.com" />
                                <span asp-validation-for="Email" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Şifre</label>
                                <input name="Password" type="password" class="form-control" placeholder="Şifrenizi girin" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Role" class="form-label">Rol</label>
                                <select asp-for="Role" class="form-select">
                                    <option value="">Rol Seçiniz</option>
                                    <option value="1">Yönetici</option>
                                    <option value="2">Çalışan</option>
                                </select>
                                <span asp-validation-for="Role" class="text-danger small"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="AnnualLeaveQuota" class="form-label">Yıllık İzin Kotası</label>
                                <input asp-for="AnnualLeaveQuota" type="number" class="form-control" placeholder="14" min="0" max="365" value="14" />
                                <span asp-validation-for="AnnualLeaveQuota" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary">
                                Kullanıcı Ekle
                            </button>
                            <button type="reset" class="btn btn-secondary ms-2">
                                Temizle
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card text-white bg-primary">
            <div class="card-body text-center">
                <h3 class="card-title">
                    <i class="fas fa-users fa-2x mb-2 d-block"></i>
                    @ViewBag.TotalUsers
                </h3>
                <p class="card-text">Toplam Kullanıcı</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center">
                <h3 class="card-title">
                    <i class="fas fa-user-tie fa-2x mb-2 d-block"></i>
                    @ViewBag.ManagerCount
                </h3>
                <p class="card-text">Yönetici</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card text-white bg-info">
            <div class="card-body text-center">
                <h3 class="card-title">
                    <i class="fas fa-user-friends fa-2x mb-2 d-block"></i>
                    @ViewBag.EmployeeCount
                </h3>
                <p class="card-text">Çalışan</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card text-white bg-warning">
            <div class="card-body text-center">
                <h3 class="card-title">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2 d-block"></i>
                    @ViewBag.LowQuotaUsers
                </h3>
                <p class="card-text">Kotası Düşük (&lt; 5)</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>#</th>
                        <th>Ad Soyad</th>
                        <th>Email</th>
                        <th>Rol</th>
                        <th>İzin Kotası</th>
                        <th>Durum</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @if (ViewBag.Users != null && ((IEnumerable<ResultUserDto>)ViewBag.Users).Any())
                    {
                        int counter = 1;
                        @foreach (var user in (IEnumerable<ResultUserDto>)ViewBag.Users)
                        {
                            <tr onclick='showUserDetail(@Html.Raw(Json.Serialize(user)))' style="cursor: pointer;">
                                <td>@counter</td>
                                <td>
                                    <strong>@user.FirstName @user.LastName</strong><br />
                                    <small class="text-muted">@user.Email</small>
                                </td>
                                <td>@user.Email</td>
                                <td>
                                    @if (user.Role.ToString() == "Manager")
                                    {
                                        <span class="badge bg-warning">Yönetici</span>
                                    }
                                    else if (user.Role.ToString() == "Employee")
                                    {
                                        <span class="badge bg-primary">Çalışan</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Bilinmeyen</span>
                                    }
                                </td>
                                <td>
                                    @if (user.AnnualLeaveQuota <= 5)
                                    {
                                        <span class="badge bg-danger">@user.AnnualLeaveQuota gün</span>
                                    }
                                    else if (user.AnnualLeaveQuota <= 10)
                                    {
                                        <span class="badge bg-warning">@user.AnnualLeaveQuota gün</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">@user.AnnualLeaveQuota gün</span>
                                    }
                                </td>
                                <td>
                                    <span class="badge bg-success">Aktif</span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-info btn-sm"
                                                onclick="event.stopPropagation(); showUserDetail(@Html.Raw(Json.Serialize(user)))"
                                                title="Detay">
                                            Detay
                                        </button>
                                        <button type="button" class="btn btn-danger btn-sm"
                                                onclick="event.stopPropagation(); confirmDelete('@user.FirstName @user.LastName', '@user.Email')"
                                                title="Sil">
                                            Sil
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            counter++;
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="text-center text-muted">Henüz kullanıcı bulunmamaktadır.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="userDetailModal" tabindex="-1" aria-labelledby="userDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="userDetailModalLabel">
                    <i class="fas fa-user me-2"></i>
                    Kullanıcı Detayları
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="userDetailContent">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Kullanıcı Sil
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmText">Bu kullanıcıyı silmek istediğinizden emin misiniz?</p>
            </div>
            <div class="modal-footer">
                <form asp-action="DeleteUser" asp-controller="Manager" method="post" style="display: inline;" onsubmit="handleSubmit(this)">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="email" id="deleteusermodalId" />
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>

                    <button type="submit" class="btn btn-danger">
                        Sil
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
        function showUserDetail(user) {
        let leaveRequestsHtml = '';

        if (user.leaveRequests && user.leaveRequests.length > 0) {
            leaveRequestsHtml = `
                <hr />
                <h5>İzin Geçmişi</h5>
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Başlangıç</th>
                            <th>Bitiş</th>
                            <th>Tür</th>
                            <th>Açıklama</th>
                            <th>Durum</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${user.leaveRequests.map(lr => `
                            <tr class="${lr.conflictLeaveUser ? 'table-warning' : ''}">
                                <td>${formatDate(lr.startDate)}</td>
                                <td>${formatDate(lr.endDate)}</td>
                                <td>${getLeaveTypeText(lr.leaveType)}</td>
                                <td>${lr.description || '-'}</td>
                                <td>${getLeaveStatusBadge(lr.status)}</td>
                                
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } else {
            leaveRequestsHtml = `<p class="text-muted">İzin geçmişi bulunmamaktadır.</p>`;
        }

        const content = `
            <div class="row">
                <div class="col-12">
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Ad:</strong></td>
                            <td>${user.firstName}</td>
                        </tr>
                        <tr>
                            <td><strong>Soyad:</strong></td>
                            <td>${user.lastName}</td>
                        </tr>
                        <tr>
                            <td><strong>Email:</strong></td>
                            <td>${user.email}</td>
                        </tr>
                        <tr>
                            <td><strong>Rol:</strong></td>
                            <td>
                                ${user.role === 1 ?
                                    '<span class="badge bg-warning">Yönetici</span>' :
                                    '<span class="badge bg-primary">Çalışan</span>'}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>İzin Kotası:</strong></td>
                            <td>
                                <span class="badge ${user.annualLeaveQuota <= 5 ? 'bg-danger' :
                                    user.annualLeaveQuota <= 10 ? 'bg-warning' : 'bg-success'}">
                                    ${user.annualLeaveQuota} gün
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Durum:</strong></td>
                            <td><span class="badge bg-success">Aktif</span></td>
                        </tr>
                    </table>
                    ${leaveRequestsHtml}
                </div>
            </div>
        `;

        document.getElementById('userDetailContent').innerHTML = content;
        new bootstrap.Modal(document.getElementById('userDetailModal')).show();
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('tr-TR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }

    function getLeaveTypeText(type) {
        switch (type) {
            case 1: return 'Yıllık İzin';
            case 2: return 'Hastalık İzni';
            case 3: return 'Doğum İzni';
            case 4: return 'Taziye İzni';
            case 5: return 'Evlilik İzni';
            default: return 'Bilinmiyor';
        }
    }

    function getLeaveStatusBadge(status) {
        switch (status) {
            case 0: return '<span class="badge bg-secondary">Beklemede</span>';
            case 1: return '<span class="badge bg-success">Onaylandı</span>';
            case 2: return '<span class="badge bg-danger">Reddedildi</span>';
            default: return '<span class="badge bg-light">Bilinmiyor</span>';
        }
    }


    function confirmDelete(userName,id) {
        document.getElementById('deleteConfirmText').innerText = `${userName} isimli kullanıcıyı silmek istediğinizden emin misiniz?`;
        document.getElementById('deleteusermodalId').value = id;
        new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
    }

    function deleteUser() {
        alert('Kullanıcı silme işlemi gerçekleştirilecek');
        bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
    }

</script>
<script>
    function handleSubmit(form) {
        const btn = form.querySelector("button[type='submit']");
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Gönderiliyor...';
    }
</script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}